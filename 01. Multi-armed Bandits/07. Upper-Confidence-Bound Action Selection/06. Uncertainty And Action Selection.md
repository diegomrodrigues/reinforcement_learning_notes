## Upper-Confidence-Bound Action Selection e a Din√¢mica da Incerteza

### Introdu√ß√£o
O conceito de **Upper-Confidence-Bound (UCB)** action selection emerge como uma estrat√©gia para lidar com o *trade-off* entre **explora√ß√£o** e **explota√ß√£o** em problemas de *multi-armed bandits*. Diferente dos m√©todos $\epsilon$-greedy, que exploram aleatoriamente, o UCB busca explorar a√ß√µes com base em sua potencialidade de serem √≥timas, considerando tanto a estimativa de seu valor quanto a incerteza associada a essa estimativa [1](https://chatgpt.com/c/67829922-359c-8011-96dd-970c04ed772c#user-content-fn-1). Este cap√≠tulo explorar√° como o UCB opera, enfatizando a din√¢mica da incerteza que guia o processo de sele√ß√£o de a√ß√µes.

### Conceitos Fundamentais
O **UCB** opera sob a premissa de que a incerteza na estimativa do valor de uma a√ß√£o deve influenciar a decis√£o de explor√°-la. A ideia central √© escolher a√ß√µes que apresentem um limite superior de confian√ßa, ou seja, um valor que √© a soma da estimativa atual de seu valor e um termo que representa sua incerteza [1](https://chatgpt.com/c/67829922-359c-8011-96dd-970c04ed772c#user-content-fn-1). A a√ß√£o $A_t$ no tempo $t$ √© selecionada de acordo com a seguinte f√≥rmula:

$$
A_t = \underset{a}{\text{argmax}} \left[ Q_t(a) + c \sqrt{\frac{\ln{t}}{N_t(a)}} \right]
$$

Onde:
- $Q_t(a)$ representa a estimativa do valor da a√ß√£o $a$ no tempo $t$.
- $N_t(a)$ √© o n√∫mero de vezes que a a√ß√£o $a$ foi selecionada at√© o tempo $t$.
- $c > 0$ √© um par√¢metro que controla o n√≠vel de explora√ß√£o, definindo o qu√£o grande √© a "confian√ßa" que damos √† estimativa do valor de cada a√ß√£o e, consequentemente, o qu√£o dispostos estamos a explorar a√ß√µes pouco testadas.
- $\ln{t}$ representa o logaritmo natural do tempo, que faz com que o termo de incerteza diminua com o tempo e com o n√∫mero de vezes que uma a√ß√£o √© selecionada.

> üí° **Exemplo Num√©rico:** Vamos considerar um cen√°rio com tr√™s a√ß√µes (a1, a2, a3). Inicialmente, todas as a√ß√µes t√™m $Q_t(a) = 0$ e $N_t(a) = 0$. Seja $c = 1$.
>
> - No tempo $t=1$:
>   - Para todas as a√ß√µes, o termo de incerteza √© $\sqrt{\frac{\ln{1}}{0}}$, que √© indefinido. Na pr√°tica, para evitar a divis√£o por zero, inicializamos os contadores $N_t(a)$ com um valor pequeno, como 1, ou garantimos que cada a√ß√£o seja selecionada pelo menos uma vez no in√≠cio. Vamos assumir que cada a√ß√£o foi selecionada uma vez na inicializa√ß√£o, ent√£o $N_1(a)=1$ para $a \in \{a_1, a_2, a_3\}$.
>   - Para cada a√ß√£o, o valor UCB ser√° $0 + 1 \cdot \sqrt{\frac{\ln{1}}{1}} = 0$.  Como os valores UCB s√£o iguais, a primeira a√ß√£o, $a_1$, √© selecionada arbitrariamente.
>   - Atualizamos $N_1(a_1)$ para 2.
>
> - No tempo $t=2$:
>   - $N_2(a_1) = 2$, $N_2(a_2) = 1$, $N_2(a_3) = 1$.
>   - O termo de incerteza para $a_1$ √© $\sqrt{\frac{\ln{2}}{2}} \approx 0.588$, para $a_2$ e $a_3$ √© $\sqrt{\frac{\ln{2}}{1}} \approx 0.833$.
>   - Se $Q_2(a_1) = 0.2$, $Q_2(a_2) = 0.1$, $Q_2(a_3) = 0$, o valor UCB para $a_1$ ser√° $0.2 + 0.588 = 0.788$, para $a_2$ ser√° $0.1 + 0.833 = 0.933$, e para $a_3$ ser√° $0 + 0.833 = 0.833$.
>   - A a√ß√£o $a_2$ √© selecionada no tempo 2 porque tem o maior valor UCB.
>
>   - Atualizamos $N_2(a_2)$ para 2.
>
> - No tempo $t=3$:
>    - $N_3(a_1) = 2$, $N_3(a_2) = 2$, $N_3(a_3) = 1$.
>    - O termo de incerteza para $a_1$ e $a_2$ √© $\sqrt{\frac{\ln{3}}{2}} \approx 0.732$, para $a_3$ √© $\sqrt{\frac{\ln{3}}{1}} \approx 1.099$.
>    - Se $Q_3(a_1) = 0.3$, $Q_3(a_2) = 0.4$, $Q_3(a_3) = 0.1$, o valor UCB para $a_1$ ser√° $0.3 + 0.732 = 1.032$, para $a_2$ ser√° $0.4 + 0.732 = 1.132$, e para $a_3$ ser√° $0.1 + 1.099 = 1.199$.
>   - A a√ß√£o $a_3$ √© selecionada no tempo 3.

A caracter√≠stica fundamental do UCB √© a forma como ele ajusta dinamicamente o *trade-off* entre **explora√ß√£o** e **explota√ß√£o**. A raiz quadrada da raz√£o entre o logaritmo de $t$ (tempo) e o n√∫mero de vezes que a a√ß√£o $a$ foi selecionada, $N_t(a)$, quantifica a incerteza associada √† a√ß√£o. Inicialmente, a√ß√µes pouco exploradas t√™m um valor alto neste termo, encorajando a explora√ß√£o. √Ä medida que uma a√ß√£o √© selecionada repetidamente, seu $N_t(a)$ aumenta, diminuindo seu termo de incerteza e, assim, a prioridade de ser selecionada [1](https://chatgpt.com/c/67829922-359c-8011-96dd-970c04ed772c#user-content-fn-1].

**Proposi√ß√£o 1:** *A fun√ß√£o de incerteza $f(t, N_t(a)) = c \sqrt{\frac{\ln t}{N_t(a)}}$ √© decrescente em rela√ß√£o a $N_t(a)$ e crescente em rela√ß√£o a $t$.*

*Prova:* A derivada parcial de $f$ em rela√ß√£o a $N_t(a)$ √© $\frac{\partial f}{\partial N_t(a)} = c \sqrt{\ln t} \cdot (-\frac{1}{2}) N_t(a)^{-3/2} = -\frac{c}{2} \sqrt{\frac{\ln t}{N_t(a)^3}}$, que √© negativa para $c > 0$, $t > 1$ e $N_t(a) > 0$. Portanto, $f$ √© decrescente em rela√ß√£o a $N_t(a)$. A derivada parcial de $f$ em rela√ß√£o a $t$ √© $\frac{\partial f}{\partial t} = c \frac{1}{2} \sqrt{\frac{1}{N_t(a)}} (\ln t)^{-1/2} \frac{1}{t} = \frac{c}{2t} \sqrt{\frac{1}{N_t(a)\ln t}}$, que √© positiva para $c > 0$, $t > 1$ e $N_t(a) > 0$. Portanto, $f$ √© crescente em rela√ß√£o a $t$.  $\blacksquare$

> üí° **Exemplo Num√©rico:** Vamos analisar a Proposi√ß√£o 1 com $c = 1$ e $t = 10$.
>
> - Se $N_t(a) = 1$, a incerteza √© $f(10, 1) = \sqrt{\frac{\ln 10}{1}} \approx 1.517$.
> - Se $N_t(a) = 2$, a incerteza √© $f(10, 2) = \sqrt{\frac{\ln 10}{2}} \approx 1.073$. Note que a incerteza diminuiu.
> - Agora, fixando $N_t(a) = 1$, e aumentando $t$ para 20: $f(20, 1) = \sqrt{\frac{\ln 20}{1}} \approx 1.729$. Note que a incerteza aumentou com $t$.
>
> Isso demonstra numericamente que a incerteza decresce com o aumento de $N_t(a)$ e cresce com o aumento de $t$, conforme estabelecido pela proposi√ß√£o.

A incerteza √© um componente crucial da sele√ß√£o de a√ß√µes pelo UCB. A f√≥rmula do UCB [1](https://chatgpt.com/c/67829922-359c-8011-96dd-970c04ed772c#user-content-fn-1) destaca como a incerteza sobre o valor das a√ß√µes afeta diretamente a escolha da a√ß√£o a ser tomada. A√ß√µes com menor n√∫mero de sele√ß√µes, ou seja, maior incerteza sobre seu valor, t√™m um *boost* em sua pontua√ß√£o, incentivando o agente a explor√°-las. Isso √© particularmente √∫til no come√ßo do processo de aprendizado, quando todas as a√ß√µes ainda s√£o relativamente desconhecidas. Quando uma a√ß√£o √© escolhida, essa a√ß√£o tem a incerteza reduzida (aumenta $N_t(a)$), o que a torna menos propensa a ser selecionada em compara√ß√£o com outras a√ß√µes ainda n√£o exploradas, dado que o fator de incerteza decresce com o aumento de $N_t(a)$. Por outro lado, a√ß√µes n√£o selecionadas ganham incerteza com o aumento de $t$ atrav√©s do termo $\sqrt{\ln(t)}$.

```mermaid
graph LR
    subgraph "Fun√ß√£o de Incerteza"
    A["f(t, N_t(a)) = c * sqrt(ln(t) / N_t(a))"]
    B["Derivada Parcial em rela√ß√£o a N_t(a): ‚àÇf/‚àÇN_t(a) < 0"]
    C["Derivada Parcial em rela√ß√£o a t: ‚àÇf/‚àÇt > 0"]
    A --> B
    A --> C
    end
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#ccf,stroke:#333,stroke-width:2px
     style C fill:#ccf,stroke:#333,stroke-width:2px
```

**Lemma 1:** *O termo de incerteza no UCB, dado por $c\sqrt{\frac{\ln{t}}{N_t(a)}}$, diminui quando uma a√ß√£o √© selecionada e aumenta quando as demais a√ß√µes s√£o selecionadas.*

*Prova:* Considere uma a√ß√£o $a$ selecionada no tempo $t$. No pr√≥ximo passo $t+1$, o valor de $N_{t+1}(a)$ aumentar√° em uma unidade, enquanto $N_{t+1}(a')$ para as demais a√ß√µes $a'$ n√£o mudar√°. O termo $\ln(t)$ √© afetado em todas as a√ß√µes, mas em geral $\ln(t+1) \approx \ln(t)$. Assim:
- A incerteza da a√ß√£o $a$:  $c\sqrt{\frac{\ln{t}}{N_t(a)}} > c\sqrt{\frac{\ln{(t+1)}}{N_{t+1}(a)}}$, dado que $N_{t+1}(a) = N_t(a) + 1$.
- A incerteza de outras a√ß√µes $a'$: $c\sqrt{\frac{\ln{t}}{N_t(a')}} < c\sqrt{\frac{\ln{(t+1)}}{N_{t+1}(a')}}$, dado que $N_{t+1}(a') = N_t(a')$.
Isso demonstra que a incerteza sobre uma a√ß√£o diminui ao ser selecionada enquanto a incerteza nas demais a√ß√µes aumenta. $\blacksquare$

> üí° **Exemplo Num√©rico:**  Vamos ilustrar o Lemma 1 com $c=1$, $t=5$ e duas a√ß√µes $a_1$ e $a_2$. Suponha que no tempo $t=5$, $N_5(a_1)=3$ e $N_5(a_2)=2$.
>
> - Incerteza de $a_1$ no tempo 5: $\sqrt{\frac{\ln{5}}{3}} \approx 0.732$.
> - Incerteza de $a_2$ no tempo 5: $\sqrt{\frac{\ln{5}}{2}} \approx 0.912$.
>
> Agora, suponha que $a_1$ √© selecionada no tempo 6.
>
> - Incerteza de $a_1$ no tempo 6: $\sqrt{\frac{\ln{6}}{4}} \approx 0.672$.  A incerteza diminuiu.
> - Incerteza de $a_2$ no tempo 6: $\sqrt{\frac{\ln{6}}{2}} \approx 0.896$.  A incerteza aumentou (devido ao aumento de t) e se mant√©m maior que a de $a_1$
>
>Este exemplo num√©rico demonstra que a incerteza da a√ß√£o selecionada diminui enquanto a incerteza da a√ß√£o n√£o selecionada aumenta.

**Lemma 1.1:** *Se duas a√ß√µes $a_1$ e $a_2$ s√£o selecionadas exatamente o mesmo n√∫mero de vezes, $N_t(a_1) = N_t(a_2)$, o termo de incerteza para ambas ser√° o mesmo no instante t.*

*Prova:*  Se $N_t(a_1) = N_t(a_2)$, ent√£o $c\sqrt{\frac{\ln{t}}{N_t(a_1)}} = c\sqrt{\frac{\ln{t}}{N_t(a_2)}}$.  Portanto, o termo de incerteza √© id√™ntico para ambas as a√ß√µes no instante $t$. $\blacksquare$

> üí° **Exemplo Num√©rico:** Seja $c=1$ e $t=10$. Se $N_{10}(a_1) = 5$ e $N_{10}(a_2) = 5$, ent√£o:
>
> - Incerteza de $a_1$ no tempo 10: $\sqrt{\frac{\ln{10}}{5}} \approx 0.680$
> - Incerteza de $a_2$ no tempo 10: $\sqrt{\frac{\ln{10}}{5}} \approx 0.680$
>
> Como demonstrado, as incertezas s√£o id√™nticas.

Essa din√¢mica de incerteza √© essencial para o desempenho do UCB. Ela garante que o agente n√£o fique preso explorando a√ß√µes sub√≥timas ou explora demais a√ß√µes j√° bem conhecidas. A redu√ß√£o da incerteza sobre a a√ß√£o selecionada permite que o agente refine suas estimativas sobre seu valor, levando a uma melhoria gradual na qualidade das decis√µes.

**Teorema 1:** *O UCB garante que todas as a√ß√µes ser√£o exploradas infinitas vezes no limite quando o n√∫mero de passos $t$ tende a infinito.*

*Prova (Esbo√ßo):* A prova envolve mostrar que para qualquer a√ß√£o $a$ com valor √≥timo, eventualmente $Q_t(a)$ se aproximar√° do seu valor verdadeiro. O termo de incerteza $\sqrt{\frac{\ln(t)}{N_t(a)}}$ eventualmente se tornar√° pequeno o suficiente para permitir que $a$ seja selecionada novamente, mesmo que inicialmente tenha sido desfavorecida. Como $\ln(t)$ cresce lentamente com $t$, enquanto $N_t(a)$ s√≥ cresce quando a a√ß√£o $a$ √© selecionada, o termo de incerteza nunca chega a zero e garante que nenhuma a√ß√£o ser√° eternamente negligenciada, resultando em uma explora√ß√£o cont√≠nua. $\blacksquare$

> üí° **Visualiza√ß√£o da Din√¢mica de Incerteza:** A seguinte visualiza√ß√£o ilustra o decr√©scimo do termo de incerteza para uma a√ß√£o conforme ela √© selecionada, enquanto o termo de incerteza para outras a√ß√µes n√£o selecionadas aumenta.
> ```mermaid
> graph LR
>     A["Tempo (t)"] --> B("A√ß√£o a1 √© selecionada")
>     B --> C{"N_t(a1) aumenta"};
>     C --> D["Incerteza de a1 diminui"]
>     A --> E("Outras a√ß√µes n√£o s√£o selecionadas")
>     E --> F["Incerteza das outras a√ß√µes aumenta"]
>
>     style A fill:#f9f,stroke:#333,stroke-width:2px
>     style B fill:#ccf,stroke:#333,stroke-width:2px
>     style D fill:#ccf,stroke:#333,stroke-width:2px
>      style F fill:#ccf,stroke:#333,stroke-width:2px
> ```

### Conclus√£o
O m√©todo de sele√ß√£o de a√ß√µes UCB oferece uma abordagem sofisticada para equilibrar **explora√ß√£o** e **explota√ß√£o** em problemas de *multi-armed bandits*. A chave para seu sucesso √© a maneira como ele utiliza a incerteza na estimativa do valor das a√ß√µes. Ao priorizar a√ß√µes com maior incerteza, o UCB incentiva a explora√ß√£o de novas possibilidades e, ao mesmo tempo, reduz a incerteza sobre a√ß√µes j√° exploradas, levando a uma tomada de decis√£o mais eficiente e ao aprendizado de uma pol√≠tica mais eficaz ao longo do tempo [1](https://chatgpt.com/c/67829922-359c-8011-96dd-970c04ed772c#user-content-fn-1). O UCB, apesar de ser menos simples que o $\epsilon$-greedy, consegue aliar as vantagens de ambos, realizando uma busca mais eficiente em compara√ß√£o com outras t√©cnicas.

### Refer√™ncias
[^1]: "The idea of this upper confidence bound (UCB) action selection is that the square-root term is a measure of the uncertainty or variance in the estimate of a's value. The quantity being max'ed over is thus a sort of upper bound on the possible true value of action a, with c determining the confidence level. Each time a is selected the uncertainty is presumably reduced: N≈Ç(a) increments, and, as it appears in the denominator, the uncertainty term decreases. On the other hand, each time an action other than a is selected, t increases but Nt(a) does not; because t appears in the numerator, the uncertainty estimate increases." *(Trecho de <Multi-armed Bandits>)*
